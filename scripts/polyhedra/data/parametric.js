/**
 * Parametric Polyhedra - Prisms, Antiprisms, Pyramids, Bipyramids, Trapezohedra
 * 
 * These are infinite families of polyhedra generated by parameter n (number of sides).
 * All have explicit face definitions.
 */

// Helper: Generate regular n-gon vertices at height h
function ngon(n, radius = 1, height = 0, rotation = 0) {
  const verts = [];
  for (let i = 0; i < n; i++) {
    const angle = (2 * Math.PI * i) / n + rotation;
    verts.push([radius * Math.cos(angle), radius * Math.sin(angle), height]);
  }
  return verts;
}

/**
 * Generate a prism with n-gonal bases
 */
function generatePrism(n) {
  const r = 1 / (2 * Math.sin(Math.PI / n)); // Circumradius for unit edge
  const h = 1; // Unit height
  const bottom = ngon(n, r, 0);
  const top = ngon(n, r, h);
  
  const faces = [
    // Bottom face (reversed for outward normal)
    Array.from({ length: n }, (_, i) => n - 1 - i),
    // Top face
    Array.from({ length: n }, (_, i) => n + i),
  ];
  
  // Side faces (rectangles)
  for (let i = 0; i < n; i++) {
    faces.push([i, (i + 1) % n, n + ((i + 1) % n), n + i]);
  }
  
  return {
    vertices: [...bottom, ...top],
    faces
  };
}

/**
 * Generate an antiprism with n-gonal bases
 */
function generateAntiprism(n) {
  const r = 1 / (2 * Math.sin(Math.PI / n));
  const h = Math.sqrt(1 - 1 / (4 * Math.cos(Math.PI / (2 * n)) ** 2));
  const bottom = ngon(n, r, 0);
  const top = ngon(n, r, h, Math.PI / n); // Rotated by Ï€/n
  
  const faces = [
    // Bottom face
    Array.from({ length: n }, (_, i) => n - 1 - i),
    // Top face
    Array.from({ length: n }, (_, i) => n + i),
  ];
  
  // Side faces (triangles)
  for (let i = 0; i < n; i++) {
    // Triangle pointing up
    faces.push([i, (i + 1) % n, n + i]);
    // Triangle pointing down
    faces.push([n + i, (i + 1) % n, n + ((i + 1) % n)]);
  }
  
  return {
    vertices: [...bottom, ...top],
    faces
  };
}

/**
 * Generate a pyramid with n-gonal base
 */
function generatePyramid(n) {
  const r = 1 / (2 * Math.sin(Math.PI / n));
  // Use fixed height ratio - unit-edge formula fails when r >= 1 (n >= 6)
  const h = r * 0.8;
  const base = ngon(n, r, 0);
  const apex = [[0, 0, h]];
  
  const faces = [
    // Base face
    Array.from({ length: n }, (_, i) => n - 1 - i),
  ];
  
  // Side faces (triangles)
  for (let i = 0; i < n; i++) {
    faces.push([i, (i + 1) % n, n]);
  }
  
  return {
    vertices: [...base, ...apex],
    faces
  };
}

/**
 * Generate a bipyramid (dipyramid) with n vertices in the middle ring
 */
function generateBipyramid(n) {
  const r = 1 / (2 * Math.sin(Math.PI / n));
  // Use fixed height ratio - unit-edge formula fails when r >= 1 (n >= 6)
  const h = r * 0.8;
  const middle = ngon(n, r, 0);
  const top = [[0, 0, h]];
  const bottom = [[0, 0, -h]];
  
  const faces = [];
  
  // Top triangles
  for (let i = 0; i < n; i++) {
    faces.push([i, (i + 1) % n, n]);
  }
  
  // Bottom triangles
  for (let i = 0; i < n; i++) {
    faces.push([(i + 1) % n, i, n + 1]);
  }
  
  return {
    vertices: [...middle, ...top, ...bottom],
    faces
  };
}

/**
 * Generate a trapezohedron with 2n kite faces
 */
function generateTrapezohedron(n) {
  const r = 1;
  const h = 0.5;
  const twist = Math.PI / n;
  
  const bottom = ngon(n, r, -h);
  const top = ngon(n, r, h, twist);
  const apex_top = [[0, 0, h + 0.5]];
  const apex_bottom = [[0, 0, -h - 0.5]];
  
  const faces = [];
  
  // Kite faces
  for (let i = 0; i < n; i++) {
    // Upper kite
    faces.push([n + i, (i + 1) % n, n + ((i + 1) % n), 2 * n]);
    // Lower kite  
    faces.push([i, n + i, (i + 1) % n, 2 * n + 1]);
  }
  
  return {
    vertices: [...bottom, ...top, ...apex_top, ...apex_bottom],
    faces
  };
}

// Generate all parametric shapes for n = 3 to 8
function generateAllParametric() {
  const shapes = {};
  
  for (let n = 3; n <= 8; n++) {
    const name = ['triangular', 'square', 'pentagonal', 'hexagonal', 'heptagonal', 'octagonal'][n - 3];
    
    shapes[`${name}_prism`] = generatePrism(n);
    shapes[`${name}_antiprism`] = generateAntiprism(n);
    
    if (n >= 3 && n <= 6) {
      shapes[`${name}_pyramid`] = generatePyramid(n);
      shapes[`${name}_bipyramid`] = generateBipyramid(n);
    }
    
    if (n >= 3 && n <= 5) {
      shapes[`${name}_trapezohedron`] = generateTrapezohedron(n);
    }
  }
  
  return shapes;
}

module.exports = {
  generatePrism,
  generateAntiprism,
  generatePyramid,
  generateBipyramid,
  generateTrapezohedron,
  generateAllParametric
};

