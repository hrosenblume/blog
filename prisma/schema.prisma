generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

model Post {
  id             String     @id @default(uuid())
  title          String
  slug           String     @unique
  markdown       String
  status         String     @default("draft") // "draft", "published", "suggested", "deleted"
  polyhedraShape String?
  createdAt      DateTime   @default(now())
  updatedAt      DateTime   @updatedAt
  publishedAt    DateTime?
  subtitle       String?
  revisions      Revision[]
  tags           PostTag[]
  comments       Comment[]
  
  // SEO fields (optional overrides)
  seoTitle       String?
  seoDescription String?
  seoKeywords    String?
  noIndex        Boolean    @default(false)
  ogImage        String?    // Custom Open Graph image URL
  
  // Auto-draft fields (for suggested posts)
  sourceUrl      String?    // Original article URL
  topicId        String?    // TopicSubscription that generated this
  topic          TopicSubscription? @relation(fields: [topicId], references: [id])
  newsItem       NewsItem?  // Reverse relation to source news item
}

model Revision {
  id             String   @id @default(uuid())
  postId         String
  title          String?
  subtitle       String?
  markdown       String
  polyhedraShape String?
  createdAt      DateTime @default(now())
  post           Post     @relation(fields: [postId], references: [id], onDelete: Cascade)
  
  // SEO fields
  seoTitle       String?
  seoDescription String?
  seoKeywords    String?
}

model User {
  id        String    @id @default(uuid())
  email     String    @unique
  name      String?
  role      String    @default("writer")
  createdAt DateTime  @default(now())
  comments  Comment[]
}

model Lead {
  id         String      @id @default(uuid())
  email      String?     @unique
  firstName  String?
  lastName   String?
  linkedIn   String?
  title      String?
  company    String?
  companyUrl String?
  industry   String?
  employees  String?
  createdAt  DateTime    @default(now())
  updatedAt  DateTime    @updatedAt
  visits     LeadVisit[]

  @@index([company])
  @@index([linkedIn])
}

model LeadVisit {
  id         String   @id @default(uuid())
  leadId     String
  lead       Lead     @relation(fields: [leadId], references: [id], onDelete: Cascade)
  userAgent  String?
  pageUrl    String?
  referrer   String?
  rawPayload String?
  visitedAt  DateTime @default(now())

  @@index([leadId])
  @@index([visitedAt])
}

model AISettings {
  id               String   @id @default("default")
  rules            String   @default("")
  chatRules        String   @default("")
  defaultModel     String   @default("claude-sonnet")
  anthropicApiKey  String?
  openaiApiKey     String?
  generateTemplate String?  // Custom generate prompt template
  chatTemplate     String?  // Custom chat prompt template
  rewriteRules     String?  // Specific rules for magic pencil rewrites
  rewriteTemplate  String?  // Custom rewrite prompt template
  autoDraftRules     String?   // Rules for news-based essay generation
  autoDraftTemplate  String?   // Custom prompt template for auto-draft
  autoDraftWordCount Int?      // Target word count (default: 800)
  planTemplate       String?   // Custom prompt template for plan mode
  expandPlanTemplate String?   // Custom prompt template for expanding plan to essay
  updatedAt        DateTime @updatedAt
}

model SiteSettings {
  id                String   @id @default("default")
  siteTitle         String   @default("")
  siteTitleTemplate String   @default("%s | {name}")
  siteDescription   String   @default("")
  siteKeywords      String   @default("")
  twitterHandle     String   @default("")
  orgName           String   @default("")
  orgLogo           String   @default("")
  orgSameAs         String   @default("[]")
  defaultOgImage    String   @default("")  // Fallback OG image for all pages
  updatedAt         DateTime @updatedAt
}

model PageSettings {
  id          String   @id           // e.g., "home", "essays"
  path        String   @unique       // e.g., "/", "/essays"
  title       String?                // Custom page title
  description String?                // Custom meta description
  keywords    String?                // Comma-separated keywords
  noIndex     Boolean  @default(false)
  ogImage     String?                // Custom Open Graph image URL
  updatedAt   DateTime @updatedAt
}

model IntegrationSettings {
  id                  String   @id @default("default")
  googleAnalyticsId   String?  // GA4 measurement ID (G-XXXXXXXXXX)
  rb2bApiKey          String?  // RB2B tracking key
  contactEmail        String?  // Public contact email
  anthropicApiKey     String?  // Anthropic API key for Claude models
  openaiApiKey        String?  // OpenAI API key for GPT models
  autoDraftEnabled    Boolean  @default(false)  // Master toggle for auto-draft feature
  updatedAt           DateTime @updatedAt
}

// Auto-draft topic subscriptions
model TopicSubscription {
  id               String     @id @default(uuid())
  name             String                              // "School Lunch Policy"
  keywords         String                              // JSON array: ["school lunch", "USDA"]
  rssFeeds         String                              // JSON array of feed URLs
  isActive         Boolean    @default(true)
  useKeywordFilter Boolean    @default(true)           // Enable/disable keyword filtering
  frequency        String     @default("daily")        // "daily", "weekly", "manual"
  maxPerPeriod     Int        @default(3)              // Max essays per run
  essayFocus       String?                             // Per-topic essay direction/angle
  lastRunAt        DateTime?
  createdAt        DateTime   @default(now())
  updatedAt        DateTime   @updatedAt
  newsItems        NewsItem[]
  posts            Post[]                              // Posts generated from this topic
}

// News items fetched from RSS feeds
model NewsItem {
  id            String            @id @default(uuid())
  topicId       String
  topic         TopicSubscription @relation(fields: [topicId], references: [id], onDelete: Cascade)
  url           String            @unique           // Dedup key
  title         String
  summary       String?                             // RSS description
  publishedAt   DateTime?
  status        String            @default("pending") // "pending", "generated", "skipped"
  postId        String?           @unique           // Generated Post (1:1)
  post          Post?             @relation(fields: [postId], references: [id])
  createdAt     DateTime          @default(now())

  @@index([topicId])
  @@index([status])
}

// Tags for organizing posts
model Tag {
  id        String    @id @default(uuid())
  name      String    @unique
  createdAt DateTime  @default(now())
  posts     PostTag[]
}

model PostTag {
  id        String   @id @default(uuid())
  postId    String
  tagId     String
  post      Post     @relation(fields: [postId], references: [id], onDelete: Cascade)
  tag       Tag      @relation(fields: [tagId], references: [id], onDelete: Cascade)
  createdAt DateTime @default(now())

  @@unique([postId, tagId])
  @@index([postId])
  @@index([tagId])
}

// Chat history
model ChatMessage {
  id        String   @id @default(uuid())
  role      String   // "user" or "assistant"
  content   String
  createdAt DateTime @default(now())

  @@index([createdAt])
}

// Comments on posts (Google Docs style)
model Comment {
  id         String    @id @default(uuid())
  postId     String
  userId     String
  quotedText String    // Snapshot of highlighted text
  content    String
  parentId   String?   // For single-level replies
  resolved   Boolean   @default(false)
  deletedAt  DateTime? // Soft delete timestamp
  createdAt  DateTime  @default(now())
  updatedAt  DateTime  @updatedAt

  post       Post      @relation(fields: [postId], references: [id], onDelete: Cascade)
  user       User      @relation(fields: [userId], references: [id])
  parent     Comment?  @relation("Replies", fields: [parentId], references: [id], onDelete: Cascade)
  replies    Comment[] @relation("Replies")

  @@index([postId])
  @@index([parentId])
}
