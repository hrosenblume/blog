---
description: "Project architecture, tech stack, and systems reference"
globs: ["**/*"]
alwaysApply: true
---

# Project Context

> ⚠️ **THIS FILE IS COMMITTED TO GIT.** Do not add sensitive data: no emails, URLs, passwords, API keys, or secrets. Use environment variable references instead (e.g., `WRITER_EMAIL` not the actual email).

## Overview

**Hunter Rosenblume's personal essay blog** — a clean, minimal writing platform built with Next.js 15 (App Router), React 19, Prisma, NextAuth.js v5 (Google OAuth), and Tailwind CSS. Features animated 3D polyhedra, keyboard-first navigation, and DRY configuration patterns.

**URLs:**
- Production: `$NEXT_PUBLIC_SITE_URL`
- Staging: `$NEXT_PUBLIC_STAGING_URL` (Cloudflare Access protected)
- Writer dashboard: `/writer` (protected)
- Admin panel: `/admin` (admin only)

## Tech Stack

| Layer | Technology |
|-------|------------|
| Runtime | Node.js 20+ (LTS) |
| Framework | Next.js 15 (App Router) |
| UI | React 19 |
| Database | SQLite (dev) / PostgreSQL (prod) via Prisma |
| Auth | NextAuth.js v5 with Google OAuth |
| Styling | Tailwind CSS |
| Theme | next-themes (dark mode, class-based) |
| Editor | Tiptap WYSIWYG (markdown via marked + turndown) |
| 3D Graphics | Canvas API (client-side polyhedra rendering) |
| Image Storage | Local filesystem (dev) / DigitalOcean Spaces (prod) |

## Project Structure

```
blog/
├── app/                        # Next.js App Router
│   ├── api/                    # API routes
│   │   ├── admin/              # Admin-only APIs (users, revisions)
│   │   ├── auth/[...nextauth]/ # NextAuth handler
│   │   └── posts/              # Posts CRUD
│   ├── admin/                  # Admin dashboard
│   ├── auth/                   # Auth pages
│   ├── e/[slug]/               # Public essay pages
│   ├── writer/                 # Writer dashboard
│   │   └── editor/[[...slug]]/ # WYSIWYG editor
│   ├── globals.css             # Typography variables
│   └── layout.tsx              # Root layout
├── components/                 # Shared UI components
│   ├── admin/                  # AdminTable, Pagination, Field
│   ├── editor/                 # EditorToolbar, PostMetadataFooter
│   └── ui/                     # shadcn/ui components
├── lib/                        # Utilities and configs
│   ├── admin/                  # Admin utilities (pagination, constants)
│   ├── admin-nav.ts            # ✏️ Admin nav config (DRY)
│   ├── auth.ts                 # NextAuth config + route protection
│   ├── db.ts                   # Prisma client singleton
│   ├── homepage.ts             # ✏️ Homepage content (DRY)
│   ├── keyboard/               # Keyboard navigation
│   ├── leads.ts                # Lead utilities (getLeadDisplayName)
│   ├── polyhedra/              # 3D rendering system
│   ├── posts.ts                # Post CRUD logic (DRY)
│   └── storage.ts              # Image upload (local/Spaces)
├── prisma/
│   ├── schema.prisma           # SQLite (dev)
│   ├── schema.postgresql.prisma # PostgreSQL (prod)
│   └── data/                   # Exported migration data
├── plans/                      # Project planning
│   ├── Tomorrow.md             # Immediate tasks
│   └── Future.md               # Long-term ideas
├── .cursor/rules/              # Cursor AI rules
├── .github/workflows/          # GitHub Actions CI/CD
├── ecosystem.config.js         # PM2 configuration
└── start.sh                    # PM2 wrapper (loads .env.local)
```

## Database Schema

```prisma
model Post {
  id             String     @id @default(uuid())
  title          String
  subtitle       String?
  slug           String     @unique
  markdown       String
  status         String     @default("draft")  // "draft" or "published"
  polyhedraShape String?
  createdAt      DateTime   @default(now())
  updatedAt      DateTime   @updatedAt
  publishedAt    DateTime?
  revisions      Revision[]
}

model Revision {
  id             String   @id @default(uuid())
  postId         String
  title          String?
  subtitle       String?
  markdown       String
  polyhedraShape String?
  createdAt      DateTime @default(now())
  post           Post     @relation(...)
}

model User {
  id        String   @id @default(uuid())
  email     String   @unique
  name      String?
  role      String   @default("writer")  // "admin" or "writer"
  createdAt DateTime @default(now())
}

model Lead {
  id         String      @id @default(uuid())
  email      String?     @unique
  firstName  String?
  lastName   String?
  linkedIn   String?
  title      String?
  company    String?
  companyUrl String?
  industry   String?
  employees  String?
  createdAt  DateTime    @default(now())
  updatedAt  DateTime    @updatedAt
  visits     LeadVisit[]
}

model LeadVisit {
  id         String   @id @default(uuid())
  leadId     String
  lead       Lead     @relation(...)
  userAgent  String?
  pageUrl    String?
  referrer   String?
  rawPayload String?
  visitedAt  DateTime @default(now())
}
```

## Key Systems

### Typography System
Defined directly in `tailwind.config.js` with line heights:
- `text-title` (24px) — Page titles
- `text-h1` (22px) — Article H1
- `text-h2` (18px) — H2 headings
- `text-h3` (16px) — H3 headings
- `text-section` (18px) — Section headers
- `text-body` (16px) — Body text
- `text-table` (14px) — Table cells, dense data

### Article Layout System
Shared layout config in `lib/article-layout.ts` ensures essay pages and editor look identical:
- `CONTENT_WIDTH`, `CONTENT_PADDING` — Container constraints
- `TITLE_CLASSES`, `SUBTITLE_CLASSES`, `BYLINE_CLASSES` — Header typography
- `PROSE_CLASSES` — Body content styling

Components:
- `ArticleLayout` — Shared `<article>` wrapper with header/children/footer slots
- `ArticleHeader` — Title/subtitle/byline (renders inputs when `editable={true}`)
- `ArticleBody` — Prose wrapper for rendered markdown

Change `lib/article-layout.ts` or `ArticleLayout` → both essay and editor update automatically.

### Admin Pagination
Shared utilities in `lib/admin/`:
- `ITEMS_PER_PAGE` — Default pagination size (25)
- `getPaginatedData()` — Async helper that handles params, fetching, counting
- `parsePaginationParams()` — Simple params parser for complex queries

### Homepage Configuration
All content in `lib/homepage.ts`: name, bio, email, footer links.
Used by: homepage, essay pages, writer dashboard, footer.

### Admin Nav Configuration
All admin navigation in `lib/admin-nav.ts`:
- `adminNavItems` — All items with label, href, countKey
- `adminNavGroups` — Which items appear in dropdown groups
- `adminDirectLinks` — Items shown as direct links
Used by: admin layout (navbar) and admin dashboard (cards).
Adding an item to the config automatically shows it in both places.

### Polyhedra System
50+ animated 3D wireframe shapes:
- Build: `scripts/polyhedra/build-shapes.js` → `lib/polyhedra/shapes.json`
- Render: `components/PolyhedraCanvas.tsx`
- Assignment: `scripts/assign-shapes.js`

### Keyboard Navigation
Defined in `lib/keyboard/shortcuts.ts`:
- `Cmd + .` — Toggle theme
- `Cmd + /` — Toggle view (essay↔editor)
- `←`/`→` — Prev/Next essay
- `n` — New article
- `Escape` — Back to dashboard

### Editor System
`lib/editor/usePostEditor.ts` encapsulates all editor state:
- Auto-save (3s debounce)
- Revision history
- Slug generation
- Unsaved changes warning

### Image Storage System
Hybrid storage in `lib/storage.ts` with automatic backend detection:
- **Local (dev)**: Saves to `public/uploads/`, returns `/uploads/filename.jpg`
- **Production**: Uploads to DigitalOcean Spaces, returns CDN URL
- **Detection**: If `SPACES_KEY` env var is set → uses Spaces; otherwise → local filesystem
- **API**: `/api/upload` accepts multipart form data, validates type/size, returns `{ url }`
- **Supported types**: JPEG, PNG, GIF, WebP (max 4MB)

### Google Analytics
Page view tracking via Google Analytics 4:
- **Script**: `components/GoogleAnalytics.tsx` — loads gtag.js (public pages only, excludes /admin, /writer, /auth)
- **Env var**: `NEXT_PUBLIC_GA_MEASUREMENT_ID` — GA4 measurement ID (e.g., G-XXXXXXXXXX)

### RB2B Lead Tracking
Visitor identification via RB2B integration:
- **Tracking script**: `components/RB2BScript.tsx` — loads RB2B client-side script (public pages only, excludes /admin, /writer, /auth)
- **Webhook**: `/api/webhooks/rb2b` — receives identified visitor data (optionally secured with `RB2B_WEBHOOK_SECRET`)
- **Admin pages**:
  - `/admin/leads` — unique contacts
  - `/admin/leads/visits` — all visits
  - `/admin/visitors/companies` — aggregated by company
  - `/admin/visitors/persons` — identified individuals
- **Data flow**: RB2B script → RB2B servers identify visitor → webhook POST → Lead/LeadVisit created
- **Env vars**: 
  - `NEXT_PUBLIC_RB2B_API_KEY` — tracking key from RB2B dashboard
  - `RB2B_WEBHOOK_SECRET` — (optional) secret for webhook authentication

### Route Protection
Auth checks happen in layout components (client-side):
- `/writer/*` — `useSession()` hook redirects unauthenticated users to signin
- `/admin/*` — checks `session.user.role === 'admin'`, redirects non-admins to writer
This approach avoids Edge runtime limitations with Prisma.

## Authentication

- **Google OAuth** via NextAuth.js
- **Allowlist model**: Only users in `User` table can sign in
- **Roles**: `admin` (full access) or `writer` (/writer only)
- **Setup**: Set `WRITER_EMAIL` in `.env.local`, run `npm run db:setup`

## API Routes

| Endpoint | Description |
|----------|-------------|
| `/api/posts` | List/create posts |
| `/api/posts/[id]` | CRUD single post |
| `/api/admin/users` | User management (admin) |
| `/api/admin/revisions` | Revision management (admin) |
| `/api/webhooks/rb2b` | RB2B webhook receiver |
| `/api/upload` | Image upload |

## Production Deployment

### Architecture
- **Production**: `/var/www/blog` — `main` branch → port 3000
- **Staging**: `/var/www/blog-staging` — `dev` branch → port 3001
- **Database**: DigitalOcean Managed PostgreSQL
  - Production: `defaultdb`
  - Staging: `staging`
- **Reverse Proxy**: Nginx (port 80 → 3000)
- **Process Manager**: PM2 with `start.sh` wrapper
- **SSL**: Cloudflare (Flexible mode)
- **Staging Protection**: Cloudflare Tunnel + Access (Google OAuth)

### PM2 Environment Loading
PM2 doesn't load `.env.local` directly. The `start.sh` wrapper script:
1. Sources `.env.local` (loads env vars)
2. Runs `npm start`

This is required because Prisma needs `DATABASE_URL_PROD` at runtime.

### GitHub Actions
Push to `main` → deploys production
Push to `dev` → deploys staging

Workflow steps:
1. SSH into Droplet
2. `git reset --hard origin/<branch>`
3. `npm install`
4. `prisma generate + db push --accept-data-loss`
5. `npm run build:prod`
6. `pm2 restart`

### GitHub Secrets
- `DO_HOST` — Droplet IP
- `DO_USER` — SSH username
- `DO_SSH_KEY` — Private key

### Cloudflare Tunnel
Staging protected via `cloudflared` service:
- Exposes port 3001 to `$NEXT_PUBLIC_STAGING_URL`
- Google OAuth required for access
- Managed in Cloudflare Zero Trust dashboard

## Commands

| Command | Description |
|---------|-------------|
| `npm run dev` | Development server |
| `npm run dev:tunnel` | Dev + ngrok tunnel (mobile testing) |
| `npm run build:prod` | Production build (PostgreSQL) |
| `npm run db:push` | Push schema (SQLite) |
| `npm run db:push:prod` | Push schema (PostgreSQL) |
| `npm run db:studio` | Prisma Studio (SQLite) |
| `npm run db:studio:prod` | Prisma Studio (PostgreSQL) |
| `npm run db:export` | Export SQLite → JSON |
| `npm run db:import:prod` | Import JSON → PostgreSQL |

## Environment Variables

```env
DATABASE_URL="file:./dev.db"              # SQLite (dev)
DATABASE_URL_PROD="postgresql://..."      # PostgreSQL (prod)
NEXTAUTH_SECRET="<random>"
AUTH_TRUST_HOST=true
GOOGLE_CLIENT_ID="<id>"
GOOGLE_CLIENT_SECRET="<secret>"
NEXT_PUBLIC_CONTACT_EMAIL="<email>"
NEXT_PUBLIC_SITE_URL="<url>"              # Production URL
NEXT_PUBLIC_STAGING_URL="<url>"           # Staging URL
WRITER_EMAIL="<email>"                    # For db:seed
WRITER_NAME="<name>"
NGROK_DOMAIN="<domain>"                   # For dev:tunnel
NEXT_PUBLIC_RB2B_API_KEY="<key>"         # RB2B tracking key
RB2B_WEBHOOK_SECRET="<secret>"           # Optional: secure RB2B webhook
NEXT_PUBLIC_GA_MEASUREMENT_ID="<id>"     # Google Analytics 4 measurement ID

# DigitalOcean Spaces (production image storage)
SPACES_REGION="sfo3"                     # Spaces region
SPACES_BUCKET="<bucket>"                 # Spaces bucket name
SPACES_ENDPOINT="https://..."            # Spaces API endpoint
SPACES_CDN_ENDPOINT="https://..."        # Spaces CDN endpoint (for serving)
SPACES_KEY="<key>"                       # Spaces access key
SPACES_SECRET="<secret>"                 # Spaces secret key
```

## ngrok Tunnel (Mobile Testing)

`npm run dev:tunnel` starts Next.js + ngrok with OAuth protection:
- Two-layer auth: ngrok OAuth + app NextAuth
- Add both callback URLs to Google Cloud Console
- `trustHost: true` in auth config handles proxy headers
