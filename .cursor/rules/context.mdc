---
description: "Project architecture, tech stack, and systems reference"
globs: ["**/*"]
alwaysApply: true
---

# Project Context

> ⚠️ **THIS FILE IS COMMITTED TO GIT.** Do not add sensitive data: no emails, URLs, passwords, API keys, or secrets. Use environment variable references instead (e.g., `WRITER_EMAIL` not the actual email).

## Overview

**Hunter Rosenblume's personal essay blog** — a clean, minimal writing platform built with Next.js 15 (App Router), React 19, Prisma, NextAuth.js v5 (Google OAuth), and Tailwind CSS. Features animated 3D polyhedra, keyboard-first navigation, and DRY configuration patterns.

**URLs:**
- Production: `$NEXT_PUBLIC_SITE_URL`
- Staging: `$NEXT_PUBLIC_STAGING_URL` (Cloudflare Access protected)
- Writer dashboard: `/writer` (protected)
- Settings panel: `/settings` (admin only)

## Tech Stack

| Layer | Technology |
|-------|------------|
| Runtime | Node.js 20+ (LTS) |
| Framework | Next.js 15 (App Router) |
| UI | React 19 |
| Database | SQLite (dev) / PostgreSQL (prod) via Prisma |
| Auth | NextAuth.js v5 with Google OAuth |
| Styling | Tailwind CSS |
| Theme | next-themes (dark mode, class-based) |
| Editor | Tiptap WYSIWYG (markdown via marked + turndown) |
| AI/Chat | **autoblogger** package (Claude/GPT models, chat, prompts) |
| 3D Graphics | Canvas API (client-side polyhedra rendering) |
| Image Storage | Local filesystem (dev) / DigitalOcean Spaces (prod) |

## Project Structure

```
blog/
├── app/                        # Next.js App Router
│   ├── api/                    # API routes
│   │   ├── admin/              # Admin-only APIs (users, revisions)
│   │   ├── cms/[...path]/      # Autoblogger CMS API handler
│   │   ├── auth/[...nextauth]/ # NextAuth handler
│   │   └── posts/              # Posts CRUD
│   ├── (dashboard)/            # Dashboard layout group
│   │   ├── settings/           # Settings pages
│   │   └── writer/             # Writer dashboard + editor
│   ├── auth/                   # Auth pages
│   ├── e/[slug]/               # Public essay pages
│   ├── globals.css             # Typography variables
│   └── layout.tsx              # Root layout
├── components/                 # Shared UI components
│   ├── admin/                  # AdminTable, Pagination, Field
│   ├── autoblogger/            # Custom fields for autoblogger
│   └── ui/                     # shadcn/ui components
├── lib/                        # Utilities and configs
│   ├── admin/                  # Admin utilities (pagination, constants)
│   ├── admin-nav.ts            # ✏️ Admin nav config (DRY)
│   ├── auth.ts                 # NextAuth config + route protection
│   ├── chat/                   # Re-exports from autoblogger
│   ├── cms.ts                  # Autoblogger instance configuration
│   ├── db.ts                   # Prisma client singleton
│   ├── homepage.ts             # ✏️ Homepage content (DRY)
│   ├── auto-draft/             # RSS-based auto-drafting
│   ├── markdown.ts             # Re-exports from autoblogger + sanitized render
│   ├── polyhedra/              # 3D rendering system
│   ├── posts.ts                # Post CRUD logic (DRY)
│   └── storage.ts              # Image upload (local/Spaces)
├── prisma/
│   ├── schema.prisma           # SQLite (dev)
│   └── schema.postgresql.prisma # PostgreSQL (prod)
├── plans/                      # Project planning
│   └── Roadmap.md              # All planned work (Now/Soon/Later)
├── .cursor/rules/              # Cursor AI rules
├── .github/workflows/          # GitHub Actions CI/CD
├── ecosystem.config.js         # PM2 cluster mode configuration
└── server.js                   # Custom server with ready signal for zero-downtime deploys
```

## Autoblogger Package

AI writing, chat, and CMS features are provided by the **autoblogger** npm package:

### What Autoblogger Provides
- **AI Generation**: `generate()`, `buildGeneratePrompt()`, `buildAutoDraftPrompt()`
- **Chat System**: `ChatProvider`, `useChatContext()`, `ChatPanel`, agent mode editing
- **Keyboard**: `useKeyboard()` hook with `allowInInput` support
- **Markdown**: `renderMarkdown()`, `markdownToHtml()`, `htmlToMarkdown()`, `wordCount()`, `generateSlug()`
- **Content Parsing**: `parseGeneratedContent()` for title/subtitle/body extraction
- **Models**: `AI_MODELS`, `resolveModel()`, `getDefaultModel()`
- **CMS API**: `createAPIHandler()` for `/api/cms/[...path]` routes

### Blog's Local Extensions
- `lib/cms.ts` — Configures autoblogger with Prisma, auth, custom fields
- `lib/markdown.ts` — Re-exports autoblogger + `renderMarkdownSanitized()` for essays
- `lib/chat/index.ts` — Pure re-exports from `autoblogger/ui`
- `lib/auto-draft/` — RSS parsing, keyword matching, AI essay generation
- `app/providers.tsx` — Global keyboard shortcuts using autoblogger's hook

### Import Patterns
```typescript
// AI and utilities from main package
import { generate, resolveModel, buildAutoDraftPrompt, parseGeneratedContent } from 'autoblogger'
import { wordCount, generateSlug, renderMarkdown } from 'autoblogger'

// UI components and hooks from /ui subpath
import { useKeyboard, ChatProvider, useChatContext, ChatPanel } from 'autoblogger/ui'
```

## Database Schema

```prisma
model Post {
  id             String     @id @default(uuid())
  title          String
  subtitle       String?
  slug           String     @unique
  markdown       String
  status         String     @default("draft")  // "draft", "published", "suggested", "deleted"
  polyhedraShape String?
  createdAt      DateTime   @default(now())
  updatedAt      DateTime   @updatedAt
  publishedAt    DateTime?
  revisions      Revision[]
  tags           PostTag[]
  // SEO fields (optional overrides)
  seoTitle       String?
  seoDescription String?
  seoKeywords    String?
  noIndex        Boolean    @default(false)
  ogImage        String?    // Custom Open Graph image URL
  // Auto-draft fields (for suggested posts)
  sourceUrl      String?
  topicId        String?
}

model Revision {
  id             String   @id @default(uuid())
  postId         String
  title          String?
  subtitle       String?
  markdown       String
  polyhedraShape String?
  createdAt      DateTime @default(now())
  post           Post     @relation(...)
  // SEO fields
  seoTitle       String?
  seoDescription String?
  seoKeywords    String?
}

model User {
  id        String   @id @default(uuid())
  email     String   @unique
  name      String?
  role      String   @default("writer")  // "admin", "writer", or "drafter"
  createdAt DateTime @default(now())
}

model AISettings {
  id               String   @id @default("default")
  rules            String   @default("")
  chatRules        String   @default("")
  rewriteRules     String?
  autoDraftRules   String?
  defaultModel     String   @default("claude-sonnet")
  generateTemplate String?
  chatTemplate     String?
  rewriteTemplate  String?
  updatedAt        DateTime @updatedAt
}

model TopicSubscription {
  id               String     @id @default(uuid())
  name             String
  keywords         String     // JSON array
  rssFeeds         String     // JSON array
  isActive         Boolean    @default(true)
  useKeywordFilter Boolean    @default(true)
  frequency        String     @default("daily")
  maxPerPeriod     Int        @default(3)
  essayFocus       String?
  lastRunAt        DateTime?
  createdAt        DateTime   @default(now())
  updatedAt        DateTime   @updatedAt
  newsItems        NewsItem[]
  posts            Post[]
}

model NewsItem {
  id            String            @id @default(uuid())
  topicId       String
  topic         TopicSubscription @relation(...)
  url           String            @unique
  title         String
  summary       String?
  publishedAt   DateTime?
  status        String            @default("pending")
  postId        String?           @unique
  post          Post?             @relation(...)
  createdAt     DateTime          @default(now())
}
```

## Key Systems

### Typography System
Defined directly in `tailwind.config.js` with line heights:
- `text-title` (24px) — Page titles
- `text-h1` (22px) — Article H1
- `text-h2` (18px) — H2 headings
- `text-h3` (16px) — H3 headings
- `text-section` (18px) — Section headers
- `text-body` (16px) — Body text
- `text-table` (14px) — Table cells, dense data

### Keyboard Navigation
Uses autoblogger's `useKeyboard` hook from `autoblogger/ui`:
- Shortcuts defined inline in components with `{ key, metaKey, shiftKey, altKey, action, allowInInput }`
- Global shortcuts in `app/providers.tsx`: `Cmd + .` (theme), `Cmd + ;` (settings)
- Essay navigation in `KeyboardNav.tsx`: `Cmd + /` (toggle view), arrows (prev/next)

### Polyhedra System
50+ animated 3D wireframe shapes:
- Build: `scripts/polyhedra/build-shapes.js` → `lib/polyhedra/shapes.json`
- Render: `components/PolyhedraCanvas.tsx`
- Assignment: `scripts/assign-shapes.js`

### Auto-Draft System
RSS-based essay generation in `lib/auto-draft/`:
- Fetches RSS feeds, filters by keywords
- Uses autoblogger's `generate()` and `buildAutoDraftPrompt()`
- Creates suggested posts for admin review

### Route Protection
Auth checks happen in layout components (client-side):
- `/writer/*` — `useSession()` hook redirects unauthenticated users
- `/settings/*` — checks `session.user.role === 'admin'`

## API Routes

| Endpoint | Description |
|----------|-------------|
| `/api/cms/[...path]` | Autoblogger CMS API (AI, posts, settings) |
| `/api/posts` | List/create posts |
| `/api/posts/[id]` | CRUD single post |
| `/api/admin/users` | User management (admin) |
| `/api/admin/topics` | Topic subscriptions CRUD (admin) |
| `/api/webhooks/rb2b` | RB2B webhook receiver |
| `/api/upload` | Image upload |

## Commands

| Command | Description |
|---------|-------------|
| `npm run dev` | Development server |
| `npm run dev:tunnel` | Dev + ngrok tunnel (mobile testing) |
| `npm run build:prod` | Production build (PostgreSQL) |
| `npm run db:push` | Push schema (SQLite) |
| `npm run db:push:prod` | Push schema (PostgreSQL) |
| `npm run typecheck` | TypeScript type checking |

## Environment Variables

```env
DATABASE_URL="file:./dev.db"
DATABASE_URL_PROD="postgresql://..."
NEXTAUTH_SECRET="<random>"
GOOGLE_CLIENT_ID="<id>"
GOOGLE_CLIENT_SECRET="<secret>"
ANTHROPIC_API_KEY="sk-ant-..."
OPENAI_API_KEY="sk-..."
```
