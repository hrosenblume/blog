---
description: "âš ï¸ ALWAYS READ THIS FILE FIRST â€” Contains critical git commands (g/d/m/p/pf) and coding conventions"
globs: ["**/*"]
alwaysApply: true
---

# Coding Rules

> ðŸš¨ **READ THIS ENTIRE FILE AT THE START OF EVERY CONVERSATION.** This contains single-letter git commands (`g`, `d`, `m`, `p`, `pf`) that must be executed immediately when typed.

> âš ï¸ **THIS FILE IS COMMITTED TO GIT.** Do not add sensitive data: no emails, URLs, passwords, API keys, or secrets. Use environment variable references instead (e.g., `WRITER_EMAIL` not the actual email).

## Code Style

### TypeScript
- Use strict mode
- Prefer explicit types over `any`
- Use path aliases: `@/lib/*`, `@/components/*`, `@/app/*`

### React/Next.js
- Use Server Components by default
- Add `'use client'` only when hooks/interactivity are needed
- Use `useCallback` and `useMemo` for performance in client components
- Prefer async Server Components for data fetching

### Components
- Functional components only
- Props interfaces defined inline or in same file
- Use `cn()` utility from `@/lib/utils/cn` for conditional classes
- Components in `/components` are shared; page-specific stay in route `_components/` folders
- **Before creating UI components**, check `components/ui/` (shadcn) first

### Styling
- Use Tailwind CSS exclusively
- Dark mode: Use `dark:` prefix
- **NEVER** use raw Tailwind font sizes (`text-sm`, `text-lg`) â€” use custom scale (`text-title`, `text-body`, etc.)
- Use `can-hover:` variant for navigation links (prevents iOS sticky hover)

## DRY Patterns (Critical)

### Typography
Use CSS variables from `globals.css`:
- `text-title` (24px) â€” Page titles
- `text-h1` (22px) â€” Section headers
- `text-section` (18px) â€” Essay titles in lists
- `text-body` (16px) â€” Body text
- `text-table` (14px) â€” Table cells, dense data

### Centralized Configs
| Need | Location |
|------|----------|
| Homepage content | `lib/homepage.ts` |
| Admin nav items | `lib/admin-nav.ts` |
| Keyboard shortcuts | `lib/keyboard/shortcuts.ts` |
| Editor constants | `lib/editor/constants.ts` |
| Post CRUD logic | `lib/posts.ts` |
| SVG icons | `components/Icons.tsx` |
| Integrations config | `lib/integrations/config.ts` |

**NEVER** hardcode author name, email, or bio â€” use `lib/homepage.ts`

## API Routes
- Return JSON responses
- Use `withSession()` or `withAdmin()` HOC from `@/lib/auth`
- Use proper HTTP status codes (401, 403, 404, 400)

## Database
- Use singleton Prisma client from `@/lib/db`
- Keep queries in Server Components or API routes
- Always handle edge cases (not found, already exists)

## Touch/Mobile
- Use `TapLink` for nav links (iOS scroll detection)
- Add `overscroll-contain` to scrollable containers
- Add `touch-none` to fixed elements
- Support `prefers-reduced-motion`

## Don't
- Don't use inline styles
- Don't put business logic in components (use lib/)
- Don't hardcode author name/bio
- Don't commit `.env.local` files
- Don't use raw Tailwind font sizes
- Don't duplicate values â€” abstract them
- Don't define shortcuts inline â€” use `shortcuts.ts`
- Don't create UI components when shadcn has one

## Do
- Keep components small and focused
- Use semantic HTML
- Handle loading and error states
- Check existing abstractions before creating new ones
- Update `.env.example` when adding env vars
- When adding third-party integrations, use `lib/integrations/config.ts`
- Add `loading.tsx` to `/writer/*` routes with a skeleton matching the page layout

## Git Workflow

> âš ï¸ **CRITICAL: Single-letter commands are git workflow triggers.** When the user types just `g`, `d`, `m`, `p`, or `pf` â€” that IS a command. Execute immediately. Don't interpret as casual chat.

| Command | Action |
|---------|--------|
| `g` | Production commit â†’ push to `main` |
| `d` | Dev commit â†’ push to `dev` |
| `m` | Merge `dev` â†’ `main` |
| `p` | Pull current branch |
| `pf` | Force reset to `origin/main` |
| `rebuild app` | Fresh local autoblogger + restart dev:tunnel |

> âš ï¸ **NEVER push to `main` automatically.** Only push to main when the user EXPLICITLY types "g". After making changes or fixes, commit to `dev` only and WAIT for the user to type "g" before touching main.

### When user types "d" (dev commit)
1. `git status -sb` first â€” review untracked files (`??`), never auto-add `.env*`, `*.save`, `*.bak`
2. `git add -u` (tracked files only) or selectively add, then `git diff --staged --stat`
3. Read modified files for context
3. Review chat history
4. Commit with descriptive message summarizing changes
5. Push to `dev` branch

No documentation updates â€” save that for production.

### When user types "g" (production commit)
**ONLY run this when the user EXPLICITLY types "g".** Never auto-push to main after making fixes.

If on `dev` or another branch:
1. `git stash` (if uncommitted changes)
2. `git checkout main`
3. `git merge dev` (or current branch)
4. Continue with steps below, then `git checkout dev` to return

Steps:
1. **Clean up yalc if active:** `yalc remove autoblogger 2>/dev/null || true` â€” prevents committing local dev references
2. **Run `npm update autoblogger`** â€” pulls latest from npm registry, updates lock file
3. **Run `npm run typecheck`** â€” catches TypeScript errors before they fail in CI
4. `git status -sb` â€” review untracked files (`??`), never auto-add `.env*`, `*.save`, `*.bak`
5. `git add -u` (tracked files only) or selectively add, then `git diff --staged --stat`
6. Read modified files for context
7. Review chat history
8. **Update `.cursor/rules/` if significant changes were made:**
   - `rules.mdc` â€” New conventions, patterns, do's/don'ts
   - `context.mdc` â€” New systems, architecture, file structure
   - No sensitive data (URLs, emails, secrets) â€” use env var references
9. Commit with comprehensive message
10. `git push origin main` (triggers production deploy)
11. If started on another branch: `git checkout dev && git stash pop`

### When user types "m" (merge dev â†’ prod)
1. `git fetch origin && git log --oneline main..dev` to see what's being promoted
2. Review the diff: `git diff main..dev --stat`
3. Review chat history for context on what was built/changed
4. **Update `.cursor/rules/` if significant changes were made:**
   - `rules.mdc` â€” New conventions, patterns, do's/don'ts
   - `context.mdc` â€” New systems, architecture, file structure
   - No sensitive data (URLs, emails, secrets) â€” use env var references
5. If docs updated: commit on `dev` first, push to `dev`
6. Merge dev into main: `git checkout main && git merge dev`
7. Push to `main` (triggers production deploy)
8. Return to dev branch: `git checkout dev`

### When user types "p" (pull current branch)
1. `git stash` â€” save local changes
2. `git pull origin $(git branch --show-current)`
3. `git stash pop` â€” restore local changes

### When user types "pf" (force reset to main)
1. `git stash` â€” save local changes
2. `git fetch origin main`
3. `git reset --hard origin/main`

Changes are preserved in stash (`git stash list` to see, `git stash pop` to restore)

### When user types "rebuild app"
Re-link local autoblogger via yalc and restart dev server:
1. Kill any existing dev:tunnel processes
2. In autoblogger repo: `cd ../autoblogger && yalc publish`
3. In blog repo: `yalc add autoblogger`
4. Run `npm run dev:tunnel` in background

After changes in autoblogger, run `yalc push` from autoblogger repo to update all linked projects.
To revert to npm version: `yalc remove autoblogger && npm install`

## Planning Files

Project planning lives in `plans/`:

| File | Purpose |
|------|---------|
| `Roadmap.md` | All planned work organized by priority |
| `tmp/` | Working drafts and brainstorming (gitignored) |

### Roadmap.md Structure
Three sections by priority:
- **Now** â€” Active work, what I'm building next
- **Soon** â€” Queued up, scoped, ready when Now is done
- **Later** â€” Ideas worth keeping, someday/maybe

### Format
- Use `---` dividers between ideas
- Each idea gets a heading and description
- Use checklists (`- [ ]` / `- [x]`) for component tasks
- Include "Design considerations" for UI features

### Rules
- Check `Roadmap.md` at start of session to see priorities
- Promote items by moving them up (Later â†’ Soon â†’ Now)
- Add new ideas to the Later section
- Use `plans/tmp/` for messy drafts (gitignored)
- **Capture unfinished ideas:** When the user mentions a bug, feature, or improvement they want but don't implement in the current session, add it to the Roadmap (Soon for bugs, Later for features/ideas)

## Terminal Commands
Before running dev servers or long-running processes:
1. Check terminals folder if already running
2. Let user manage existing terminals
3. Don't start conflicting sandboxed commands
