# Cursor Rules for Hunter's Blog

## Project Overview
Personal essay blog built with Next.js 13 (App Router), Prisma (SQLite), NextAuth.js (Google OAuth), and Tailwind CSS. Features animated 3D polyhedra, keyboard-first navigation, and DRY configuration patterns.

## Tech Stack
- **Framework**: Next.js 13 with App Router
- **Database**: SQLite via Prisma
- **Auth**: NextAuth.js with Google OAuth
- **Styling**: Tailwind CSS with dark mode (class-based via next-themes)
- **Markdown**: marked + sanitize-html
- **3D Graphics**: Canvas API (client-side polyhedra rendering)

## Code Style

### TypeScript
- Use strict mode
- Prefer explicit types over `any`
- Use path aliases: `@/lib/*`, `@/components/*`, `@/app/*`

### React/Next.js
- Use Server Components by default
- Add `'use client'` only when hooks/interactivity are needed
- Use `useCallback` and `useMemo` for performance in client components
- Prefer async Server Components for data fetching

### Components
- Functional components only
- Props interfaces defined inline or in same file
- Use `cn()` utility from `@/lib/utils/cn` for conditional classes
- Components in `/components` are shared; page-specific components stay in route `_components/` folders

### Styling
- Use Tailwind CSS exclusively
- Dark mode: Use `dark:` prefix (e.g., `dark:bg-gray-900`)
- Button variants: primary (`bg-gray-900 dark:bg-white`) / secondary (`bg-gray-200 dark:bg-gray-800`)
- Prose/typography: Use `.prose` class with custom styles in `globals.css`

## DRY Patterns (Critical)

### 1. Typography Scale
All font sizes are CSS variables in `app/globals.css` exposed as Tailwind utilities:

| Variable | Size | Tailwind Class | Usage |
|----------|------|----------------|-------|
| `--font-title` | 24px | `text-title` | Page titles (h1) |
| `--font-h1` | 22px | `text-h1` | Section headers |
| `--font-section` | 18px | `text-section` | Essay titles in lists |
| `--font-body` | 16px | `text-body` | Body text, subtitles |

**Rules:**
- **NEVER** use raw Tailwind font sizes (`text-sm`, `text-lg`, etc.) — use the custom scale
- To change a font size globally, edit the CSS variable in `globals.css`
- Prose headings (h1-h3 inside `.prose`) also use these variables

### 2. Homepage Content
All homepage content lives in `lib/homepage.ts`:
- `name`: Author name (used in headers, bylines)
- `email`: From `NEXT_PUBLIC_CONTACT_EMAIL` env var (used by EmailLink component)
- `bio`: Array of paragraphs, each paragraph is array of `TextSegment` (text + optional href for inline links)
- `notes`: Section config (title, maxItems, emptyMessage)
- `footerLinks`: Social links array

**Used by:** `app/page.tsx`, `app/e/[slug]/page.tsx`, `app/writer/page.tsx`, `components/HomepageFooter.tsx`, `components/EmailLink.tsx`

**NEVER** hardcode author name, email, or bio text in components

### 3. Shared Styles
Reusable Tailwind class strings live in `lib/styles.ts`:
```typescript
export const tableHeaderClass = 'px-6 py-3 text-left text-xs ...'
export const cellClass = 'px-6 py-4 whitespace-nowrap text-sm ...'
```
- Used across admin tables
- Add new shared styles here, not inline

### 4. Keyboard Shortcuts
Defined in `lib/keyboard/shortcuts.ts`:
```typescript
export const SHORTCUTS = {
  THEME_TOGGLE: { key: '.', meta: true, allowInInput: true },
  TOGGLE_VIEW: { key: '/', meta: true },
  NEW_ARTICLE: { key: 'n' },
  PREV: { key: 'ArrowLeft' },
  NEXT: { key: 'ArrowRight' },
  ESCAPE_BACK: { key: 'Escape', allowInInput: true },
}
```
- Use `useKeyboard()` hook from `@/lib/keyboard`
- Add new shortcuts to `shortcuts.ts`, not inline

### API Routes
- Return JSON responses
- Always check session with `getServerSession(authOptions)`
- Admin routes: Also check `isAdmin(session.user?.email)`
- Use proper HTTP status codes (401, 403, 404, 400)

### Database
- Use singleton Prisma client from `@/lib/db`
- Keep queries in Server Components or API routes
- Always handle edge cases (not found, already exists, etc.)

## File Organization
```
app/
  _components/     # App-level client components
  api/             # API routes
  admin/           # Admin-only pages
  auth/            # Auth pages
  e/[slug]/        # Public essay pages
    _components/   # Essay-specific components
  writer/          # Protected writer dashboard
components/        # Shared components
  admin/           # Admin-specific components
lib/               # Utilities and configs
  keyboard/        # Keyboard navigation system
  polyhedra/       # 3D rendering system
  utils/           # Utility functions
prisma/            # Schema and migrations
public/            # Static assets
  polyhedra/       # Fallback GIFs
scripts/           # Build/dev scripts
  polyhedra/       # Shape generation
```

## Authentication
- Users must exist in the `User` table to sign in
- Roles: "admin" or "writer"
- Admin: full access to /admin + /writer
- Writer: access to /writer only
- Protect routes in layout.tsx files

## Key Patterns

### Data Fetching
```tsx
// Server Component (preferred)
export default async function Page() {
  const data = await prisma.post.findMany()
  return <div>{/* render */}</div>
}

// Client Component
useEffect(() => {
  fetch('/api/posts').then(res => res.json()).then(setData)
}, [])
```

### Protected Route
```tsx
'use client'
const { data: session, status } = useSession()
if (status === 'unauthenticated') redirect('/auth/signin')
if (session?.user?.role !== 'admin') redirect('/writer')
```

### API Route
```ts
export async function GET() {
  const session = await getServerSession(authOptions)
  if (!session) return NextResponse.json({ error: 'Unauthorized' }, { status: 401 })
  // ... handle request
}
```

### Keyboard Navigation
```tsx
import { useKeyboard, SHORTCUTS } from '@/lib/keyboard'

useKeyboard([
  { ...SHORTCUTS.TOGGLE_VIEW, handler: () => router.push('/writer') },
  { ...SHORTCUTS.PREV, handler: () => { if (prevSlug) router.push(`/e/${prevSlug}`) } },
])
```

## Polyhedra System

### Components
- `PolyhedraCanvas` — Client-side Canvas rendering with hover acceleration
- Shape data from `lib/polyhedra/shapes.json` (generated)

### Build Scripts
- `scripts/polyhedra/build-shapes.js` — Generate shapes.json from data/
- `scripts/assign-shapes.js` — Assign random shapes to posts

### Features
- 50+ unique shapes
- Deterministic edge colors based on shape name
- Hover: accelerates from 4s → 0.375s rotation
- `prefers-reduced-motion` support
- IntersectionObserver for visibility-based animation

## UI Conventions
- Clean, minimal design
- White/black backgrounds with gray accents
- Subtle hover states (`hover:bg-gray-50 dark:hover:bg-gray-900/30`)
- Responsive (mobile-first)
- Consistent spacing (Tailwind defaults)
- Smooth theme transitions (150ms)

## Don't
- Don't use inline styles
- Don't add unnecessary dependencies
- Don't put business logic in components (use lib/ or utils/)
- Don't hardcode the author name/bio (use `lib/homepage.ts`)
- Don't commit .env files or dev.db
- Don't use raw Tailwind font sizes (`text-sm`, `text-lg`) — use the typography scale
- Don't duplicate values — if something is used twice, abstract it
- Don't define keyboard shortcuts inline — add to `lib/keyboard/shortcuts.ts`

## Do
- Keep components small and focused
- Use semantic HTML
- Handle loading and error states
- Write self-documenting code
- Prefer server-side operations for data mutations
- Follow DRY: use CSS variables, shared utilities, and centralized configs
- Check existing abstractions before creating new ones:
  - `globals.css` for typography and theme
  - `tailwind.config.js` for custom utilities
  - `lib/homepage.ts` for homepage content
  - `lib/styles.ts` for shared class strings
  - `lib/keyboard/shortcuts.ts` for keyboard shortcuts
- Use `TapLink` for links that need iOS scroll detection
- Support `prefers-reduced-motion` for animations

## Touch Handling
- `TapLink` component handles iOS Safari tap vs scroll ambiguity
- Use it for nav links where scroll might be confused with tap
- Works with both internal routes and external URLs
