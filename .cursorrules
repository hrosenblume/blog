# Cursor Rules for Hunter's Blog

> ⚠️ **This file is committed to git.** Do not add sensitive data (API keys, emails, secrets). Use environment variables instead.

## Project Overview
Personal essay blog built with Next.js 15 (App Router), React 19, Prisma (SQLite), NextAuth.js v5 (Google OAuth), and Tailwind CSS. Features animated 3D polyhedra, keyboard-first navigation, and DRY configuration patterns. Requires Node.js 20+.

## Tech Stack
- **Runtime**: Node.js 20+ (LTS)
- **Framework**: Next.js 15 with App Router
- **Database**: SQLite via Prisma
- **Auth**: NextAuth.js v5 with Google OAuth
- **Styling**: Tailwind CSS with dark mode (class-based via next-themes)
- **Editor**: Tiptap WYSIWYG (converts to/from markdown via marked + turndown)
- **3D Graphics**: Canvas API (client-side polyhedra rendering)
- **UI**: React 19, shadcn/ui components

## Code Style

### TypeScript
- Use strict mode
- Prefer explicit types over `any`
- Use path aliases: `@/lib/*`, `@/components/*`, `@/app/*`

### React/Next.js
- Use Server Components by default
- Add `'use client'` only when hooks/interactivity are needed
- Use `useCallback` and `useMemo` for performance in client components
- Prefer async Server Components for data fetching

### Components
- Functional components only
- Props interfaces defined inline or in same file
- Use `cn()` utility from `@/lib/utils/cn` for conditional classes
- Components in `/components` are shared; page-specific components stay in route `_components/` folders
- **Before creating any new UI component**, check if shadcn/ui has one in `components/ui/`:
  - Button, Badge, Input, Label, Select, Textarea, DropdownMenu, AlertDialog
  - See https://ui.shadcn.com/docs/components for full list
  - Use `npx shadcn@latest add <component>` to add new shadcn components

### Styling
- Use Tailwind CSS exclusively
- Dark mode: Use `dark:` prefix (e.g., `dark:bg-gray-900`)
- Button variants: primary (`bg-gray-900 dark:bg-white`) / secondary (`bg-gray-200 dark:bg-gray-800`)
- Prose/typography: Use `.prose` class with custom styles in `globals.css`

## DRY Patterns (Critical)

### 1. Typography Scale
All font sizes are CSS variables in `app/globals.css` exposed as Tailwind utilities:

| Variable | Size | Tailwind Class | Usage |
|----------|------|----------------|-------|
| `--font-title` | 24px | `text-title` | Page titles (h1) |
| `--font-h1` | 22px | `text-h1` | Section headers |
| `--font-section` | 18px | `text-section` | Essay titles in lists |
| `--font-body` | 16px | `text-body` | Body text, subtitles |

**Rules:**
- **NEVER** use raw Tailwind font sizes (`text-sm`, `text-lg`, etc.) — use the custom scale
- To change a font size globally, edit the CSS variable in `globals.css`
- Prose headings (h1-h3 inside `.prose`) also use these variables

### 2. Homepage Content
All homepage content lives in `lib/homepage.ts`:
- `name`: Author name (used in headers, bylines)
- `email`: From `NEXT_PUBLIC_CONTACT_EMAIL` env var (used by EmailLink component)
- `bio`: Array of paragraphs, each paragraph is array of `TextSegment` (text + optional href for inline links)
- `notes`: Section config (title, maxItems, emptyMessage)
- `footerLinks`: Social links array

**Used by:** `app/page.tsx`, `app/e/[slug]/page.tsx`, `app/writer/page.tsx`, `components/HomepageFooter.tsx`, `components/EmailLink.tsx`

**NEVER** hardcode author name, email, or bio text in components

### 3. Shared Styles
Reusable Tailwind class strings live in `lib/styles.ts`:
```typescript
export const tableHeaderClass = 'px-6 py-3 text-left text-xs ...'
export const cellClass = 'px-6 py-4 whitespace-nowrap text-sm ...'
```
- Used across admin tables
- Add new shared styles here, not inline

### 4. Keyboard Shortcuts
Defined in `lib/keyboard/shortcuts.ts`:
```typescript
export const SHORTCUTS = {
  THEME_TOGGLE: { key: '.', meta: true, allowInInput: true },
  TOGGLE_VIEW: { key: '/', meta: true, allowInInput: true },
  NEW_ARTICLE: { key: 'n' },
  PREV: { key: 'ArrowLeft' },
  NEXT: { key: 'ArrowRight' },
  ESCAPE_BACK: { key: 'Escape', allowInInput: true },
}
```
- Use `useKeyboard()` hook from `@/lib/keyboard`
- Add new shortcuts to `shortcuts.ts`, not inline

### API Routes
- Return JSON responses
- Use `withSession()` HOC wrapper from `@/lib/auth` for protected routes
- Admin routes: Use `withAdmin()` HOC wrapper from `@/lib/auth`
- Use proper HTTP status codes (401, 403, 404, 400)

### Database
- Use singleton Prisma client from `@/lib/db`
- Keep queries in Server Components or API routes
- Always handle edge cases (not found, already exists, etc.)

## File Organization
```
app/
  _components/     # App-level client components
  api/             # API routes
  admin/           # Admin-only pages
  auth/            # Auth pages
  e/[slug]/        # Public essay pages
    _components/   # Essay-specific components
  writer/          # Protected writer dashboard
components/        # Shared components
  admin/           # Admin-specific components
lib/               # Utilities and configs
  keyboard/        # Keyboard navigation system
  polyhedra/       # 3D rendering system
  utils/           # Utility functions
prisma/            # Schema and migrations
public/            # Static assets
  polyhedra/       # Fallback GIFs
scripts/           # Build/dev scripts
  polyhedra/       # Shape generation
```

## Authentication
- Users must exist in the `User` table to sign in
- Roles: "admin" or "writer"
- Admin: full access to /admin + /writer
- Writer: access to /writer only
- Protect routes in layout.tsx files
- **First-time setup**: Set `WRITER_EMAIL` in `.env.local`, run `npm run db:setup`

## Key Patterns

### Data Fetching
```tsx
// Server Component (preferred)
export default async function Page() {
  const data = await prisma.post.findMany()
  return <div>{/* render */}</div>
}

// Client Component
useEffect(() => {
  fetch('/api/posts').then(res => res.json()).then(setData)
}, [])
```

### Protected Route
```tsx
'use client'
const { data: session, status } = useSession()
if (status === 'unauthenticated') redirect('/auth/signin')
if (session?.user?.role !== 'admin') redirect('/writer')
```

### API Route
```ts
// Using HOC wrapper (preferred)
export const GET = withSession(async (request) => {
  // session is already validated
  return NextResponse.json({ data: '...' })
})

// Or manually with auth()
export async function GET() {
  const session = await auth()
  if (!session) return unauthorized()
  // ... handle request
}
```

### Keyboard Navigation
```tsx
import { useKeyboard, SHORTCUTS } from '@/lib/keyboard'

useKeyboard([
  { ...SHORTCUTS.TOGGLE_VIEW, handler: () => router.push('/writer') },
  { ...SHORTCUTS.PREV, handler: () => { if (prevSlug) router.push(`/e/${prevSlug}`) } },
])
```

## Polyhedra System

### Components
- `PolyhedraCanvas` — Client-side Canvas rendering with hover acceleration
- Shape data from `lib/polyhedra/shapes.json` (generated)

### Build Scripts
- `scripts/polyhedra/build-shapes.js` — Generate shapes.json from data/
- `scripts/assign-shapes.js` — Assign random shapes to posts

### Features
- 50+ unique shapes
- Deterministic edge colors based on shape name
- Hover: accelerates from 4s → 0.375s rotation
- `prefers-reduced-motion` support
- IntersectionObserver for visibility-based animation

## UI Conventions
- Clean, minimal design
- White/black backgrounds with gray accents
- Subtle hover states (`hover:bg-gray-50 dark:hover:bg-gray-900/30`)
- Responsive (mobile-first)
- Consistent spacing (Tailwind defaults)
- Smooth theme transitions (150ms)

## Environment Variables

### Pattern
- `.env.example` — Template with empty values, **committed to git**
- `.env.local` — Actual values, **gitignored**

### Rules
- **NEVER** put sensitive values (API keys, secrets, emails) in code — use env vars
- **ALWAYS** keep `.env.example` updated when adding new env vars
- Use `NEXT_PUBLIC_` prefix for client-side accessible vars
- Document each env var with a comment in `.env.example`

### Current Variables
```env
DATABASE_URL          # Prisma database connection
NEXTAUTH_URL          # Leave empty for auto-detection
NEXTAUTH_SECRET       # NextAuth encryption secret
GOOGLE_CLIENT_ID      # OAuth client ID
GOOGLE_CLIENT_SECRET  # OAuth client secret
NEXT_PUBLIC_CONTACT_EMAIL  # Public contact email (mailto links)
WRITER_EMAIL          # Admin email for db:seed + ngrok OAuth allowlist
WRITER_NAME           # Admin display name for db:seed
NGROK_DOMAIN          # Your ngrok domain (for dev:tunnel)
NGROK_OAUTH_EMAIL     # Additional email for ngrok OAuth allowlist (optional)
```

### Initial Setup
```bash
cp .env.example .env.local   # Copy template
# Edit .env.local with your values
npm run db:setup             # Push schema + seed admin user
```

## Don't
- Don't use inline styles
- Don't add unnecessary dependencies
- Don't put business logic in components (use lib/ or utils/)
- Don't hardcode the author name/bio (use `lib/homepage.ts`)
- Don't commit `.env` or `.env.local` files (only `.env.example`)
- Don't put sensitive data in code — use environment variables
- Don't use raw Tailwind font sizes (`text-sm`, `text-lg`) — use the typography scale
- Don't duplicate values — if something is used twice, abstract it
- Don't define keyboard shortcuts inline — add to `lib/keyboard/shortcuts.ts`
- Don't create custom UI components when shadcn/ui has an equivalent — check `components/ui/` first

## Do
- Keep components small and focused
- Use semantic HTML
- Handle loading and error states
- Write self-documenting code
- Prefer server-side operations for data mutations
- Follow DRY: use CSS variables, shared utilities, and centralized configs
- Check existing abstractions before creating new ones:
  - `globals.css` for typography and theme
  - `tailwind.config.js` for custom utilities
  - `lib/homepage.ts` for homepage content
  - `lib/styles.ts` for shared class strings
  - `lib/keyboard/shortcuts.ts` for keyboard shortcuts
  - `lib/posts.ts` for post update logic
  - `components/Icons.tsx` for SVG icons
- Use `TapLink` for links that need iOS scroll detection
- Support `prefers-reduced-motion` for animations
- Update `.env.example` when adding new environment variables

## Touch Handling
- `TapLink` component handles iOS Safari tap vs scroll ambiguity
- Use it for nav links where scroll might be confused with tap
- Works with both internal routes and external URLs

### Mobile Scroll Fixes
When using fixed elements (header, footer, toolbar) with a scrollable content area:
- Add `overscroll-contain` to the main scrollable container (prevents scroll chaining)
- Add `touch-none` to fixed elements that don't need scroll interaction (prevents touch capture)

Example (editor page with fixed footer):
```tsx
<main className="flex-1 overflow-auto overscroll-contain">
  {/* scrollable content */}
</main>
<footer className="fixed bottom-0 ... touch-none">
  {/* non-scrollable footer */}
</footer>
```

This prevents iOS Safari from "freezing" scroll when touch starts on a fixed element.

## ngrok Tunnel (Mobile Testing)

The project supports ngrok tunneling for testing on mobile devices with OAuth protection.

### Scripts
- `npm run dev` — Local development only (localhost:3000)
- `npm run dev:tunnel` — Starts Next.js + ngrok tunnel with OAuth protection
- `npm run dev:mobile` — Alias for dev:tunnel

### How `dev:tunnel` Works
1. Loads `.env.local` variables
2. Sets `AUTH_URL` to the ngrok domain (required for OAuth callbacks)
3. Starts Next.js dev server in background
4. Starts ngrok with:
   - Custom domain from `$NGROK_DOMAIN`
   - Google OAuth protection (`--oauth=google`)
   - Email allowlist from `$NGROK_OAUTH_EMAIL` and `$WRITER_EMAIL`

### Middleware (`middleware.ts`)
The middleware handles proxy headers for OAuth to work behind ngrok:
- Forwards `x-forwarded-host` header to all routes
- Required for NextAuth to generate correct callback URLs
- Matcher excludes static files (`_next/static`, `_next/image`, etc.)

### Google OAuth Setup for ngrok
In Google Cloud Console, add BOTH callback URLs to your OAuth credentials:
- `http://localhost:3000/api/auth/callback/google`
- `https://<your-ngrok-domain>/api/auth/callback/google`

### Auth Config (`lib/auth.ts`)
- `trustHost: true` — Allows OAuth from multiple hosts
- Works with both localhost and ngrok origins

### Two-Layer Authentication
When using `dev:tunnel`:
1. **ngrok OAuth** — Protects the tunnel itself (only allowed emails can access)
2. **App NextAuth** — Your app's authentication (users must be in database)

## Git Workflow

### When user types "g"
Execute the full commit workflow — do NOT auto-commit after making changes, wait for explicit "g".

### Steps (in order)
1. **Stage & Review**: Run `git add -A && git status -sb && git diff --staged --stat`
2. **Read modified files**: Check all files listed in `git status` if needed for context
3. **Review chat history**: Understand the ENTIRE session — what was discussed, changed, and why
4. **Update documentation** (REQUIRED for significant changes):
   - **`CONTEXT.md`**: Update when adding new systems, patterns, file structure changes, or architectural decisions
   - **`.cursorrules`**: Update when adding new conventions, rules, or workflow patterns
   - No sensitive data (URLs, emails, secrets) — use env var references
5. **Stage doc updates**: If you updated docs, run `git add -A` again
6. **Commit**: Write a comprehensive message summarizing ALL changes (including doc updates)
7. **Push**: `git push origin main`

### What Requires Documentation Updates
| Change Type | Update `CONTEXT.md` | Update `.cursorrules` |
|-------------|--------------------|-----------------------|
| New file/folder structure | ✅ | — |
| New system or feature | ✅ | — |
| New code pattern or convention | — | ✅ |
| New workflow or rule | — | ✅ |
| New DRY abstraction | ✅ | ✅ |

### Commit Messages
- First line: Brief summary of the main change
- Body: List specific changes, especially for multi-file commits
- Include doc updates in the message if `.cursorrules` or `CONTEXT.md` were modified

### Key Rules
- Be thorough — full context from all chats is required
- Don't skip steps — documentation updates are part of the commit
- One atomic commit per "g" — include everything together

## Planning Files

Project planning lives in the `plans/` folder:

| File | Purpose |
|------|---------|
| `Tomorrow.md` | Immediate/short-term tasks — things to work on next |
| `Future.md` | Long-term ideas and features — someday/maybe list |
| `tmp/` | Working drafts and brainstorming (gitignored) |
