name: Deploy

on:
  push:
    branches: [main, dev]

# Prevent concurrent deploys to the same branch
# If a new push comes while deploying, cancel the old one
concurrency:
  group: deploy-${{ github.ref }}
  cancel-in-progress: true

jobs:
  security-audit:
    runs-on: ubuntu-latest
    # Run in parallel with deploy, don't block on failures
    continue-on-error: true
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      - name: Install dependencies
        run: npm ci
      - name: Security audit
        run: npm audit --audit-level=high

  deploy:
    # No 'needs' - runs in parallel with security-audit
    runs-on: ubuntu-latest
    steps:
      - name: Deploy to Production
        if: github.ref == 'refs/heads/main'
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.DO_HOST }}
          username: ${{ secrets.DO_USER }}
          key: ${{ secrets.DO_SSH_KEY }}
          command_timeout: 10m
          script: |
            set -e  # Exit immediately on any error
            cd /var/www/blog
            
            echo "=== Fetching latest code ==="
            git remote prune origin
            BEFORE_LOCK=$(md5sum package-lock.json 2>/dev/null || echo "none")
            git fetch origin main
            git reset --hard origin/main
            AFTER_LOCK=$(md5sum package-lock.json)
            
            echo "=== Installing dependencies ==="
            # Delete autoblogger to force fresh install from GitHub (avoids stale cache)
            rm -rf node_modules/autoblogger
            npm ci
            
            echo "=== Loading environment ==="
            if [ ! -f ".env.local" ]; then
              echo "ERROR: .env.local not found"
              exit 1
            fi
            export $(grep -v '^#' .env.local | xargs)
            
            echo "=== Generating Prisma client ==="
            npx prisma generate --schema=prisma/schema.postgresql.prisma
            
            echo "=== Pushing database schema ==="
            # Note: Remove --accept-data-loss when schema is stable
            # For now, using it to allow schema changes without migration files
            npx prisma db push --schema=prisma/schema.postgresql.prisma --skip-generate
            
            echo "=== Building Next.js ==="
            npm run build:prod
            
            # Verify build succeeded
            if [ ! -f ".next/prerender-manifest.json" ]; then
              echo "ERROR: Build failed - .next/prerender-manifest.json not found"
              exit 1
            fi
            echo "=== Build verified ==="
            
            echo "=== Restarting PM2 ==="
            PM2_INFO=$(pm2 jlist 2>/dev/null || echo "[]")
            if echo "$PM2_INFO" | grep -q '"name":"blog"'; then
              echo "PM2 process exists, doing reload..."
              pm2 reload blog
            else
              echo "PM2 process not found, starting fresh..."
              pm2 start ecosystem.config.js --only blog
              pm2 save
            fi
            
            # Health check - wait for server to be ready
            echo "=== Health check ==="
            sleep 3
            HEALTH_RETRIES=5
            HEALTH_OK=false
            for i in $(seq 1 $HEALTH_RETRIES); do
              if curl -sf http://localhost:3000 > /dev/null; then
                HEALTH_OK=true
                break
              fi
              echo "Health check attempt $i/$HEALTH_RETRIES failed, waiting..."
              sleep 2
            done
            
            if [ "$HEALTH_OK" = true ]; then
              echo "=== Health check passed ==="
            else
              echo "WARNING: Health check failed after $HEALTH_RETRIES attempts"
              echo "Check pm2 logs blog for details"
            fi
            
            echo "=== Deploy complete ==="

      - name: Deploy to Staging
        if: github.ref == 'refs/heads/dev'
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.DO_HOST }}
          username: ${{ secrets.DO_USER }}
          key: ${{ secrets.DO_SSH_KEY }}
          command_timeout: 10m
          script: |
            set -e  # Exit immediately on any error
            cd /var/www/blog-staging
            
            echo "=== Fetching latest code ==="
            git remote prune origin
            BEFORE_LOCK=$(md5sum package-lock.json 2>/dev/null || echo "none")
            git fetch origin dev
            git reset --hard origin/dev
            AFTER_LOCK=$(md5sum package-lock.json)
            
            echo "=== Installing dependencies ==="
            # Delete autoblogger to force fresh install from GitHub (avoids stale cache)
            rm -rf node_modules/autoblogger
            npm ci
            
            echo "=== Loading environment ==="
            if [ ! -f ".env.local" ]; then
              echo "ERROR: .env.local not found"
              exit 1
            fi
            export $(grep -v '^#' .env.local | xargs)
            
            echo "=== Generating Prisma client ==="
            npx prisma generate --schema=prisma/schema.postgresql.prisma
            
            echo "=== Pushing database schema ==="
            # Note: Remove --accept-data-loss when schema is stable
            # For now, using it to allow schema changes without migration files
            npx prisma db push --schema=prisma/schema.postgresql.prisma --skip-generate
            
            echo "=== Building Next.js ==="
            npm run build:prod
            
            # Verify build succeeded
            if [ ! -f ".next/prerender-manifest.json" ]; then
              echo "ERROR: Build failed - .next/prerender-manifest.json not found"
              exit 1
            fi
            echo "=== Build verified ==="
            
            echo "=== Restarting PM2 ==="
            PM2_INFO=$(pm2 jlist 2>/dev/null || echo "[]")
            if echo "$PM2_INFO" | grep -q '"name":"blog-staging"'; then
              echo "PM2 process exists, doing reload..."
              pm2 reload blog-staging
            else
              echo "PM2 process not found, starting fresh..."
              pm2 start ecosystem.config.js --only blog-staging
              pm2 save
            fi
            
            # Health check - wait for server to be ready
            echo "=== Health check ==="
            sleep 3
            HEALTH_RETRIES=5
            HEALTH_OK=false
            for i in $(seq 1 $HEALTH_RETRIES); do
              if curl -sf http://localhost:3001 > /dev/null; then
                HEALTH_OK=true
                break
              fi
              echo "Health check attempt $i/$HEALTH_RETRIES failed, waiting..."
              sleep 2
            done
            
            if [ "$HEALTH_OK" = true ]; then
              echo "=== Health check passed ==="
            else
              echo "WARNING: Health check failed after $HEALTH_RETRIES attempts"
              echo "Check pm2 logs blog-staging for details"
            fi
            
            echo "=== Deploy complete ==="
