name: Rollback

on:
  workflow_dispatch:
    inputs:
      commits_back:
        description: 'Number of commits to rollback'
        required: true
        default: '1'
      environment:
        description: 'Environment'
        required: true
        type: choice
        options:
          - production
          - staging

jobs:
  rollback:
    runs-on: ubuntu-latest
    steps:
      - name: Rollback Production
        if: ${{ github.event.inputs.environment == 'production' }}
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.DO_HOST }}
          username: ${{ secrets.DO_USER }}
          key: ${{ secrets.DO_SSH_KEY }}
          script: |
            cd /var/www/blog
            echo "Rolling back ${{ github.event.inputs.commits_back }} commit(s)..."
            echo "Current HEAD: $(git rev-parse --short HEAD)"
            git reset --hard HEAD~${{ github.event.inputs.commits_back }}
            echo "New HEAD: $(git rev-parse --short HEAD)"
            export $(grep -v '^#' .env.local | xargs)
            npx prisma generate --schema=prisma/schema.postgresql.prisma
            npm run build:prod
            pm2 reload blog
            echo "Rollback complete!"

      - name: Rollback Staging
        if: ${{ github.event.inputs.environment == 'staging' }}
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.DO_HOST }}
          username: ${{ secrets.DO_USER }}
          key: ${{ secrets.DO_SSH_KEY }}
          script: |
            cd /var/www/blog-staging
            echo "Rolling back ${{ github.event.inputs.commits_back }} commit(s)..."
            echo "Current HEAD: $(git rev-parse --short HEAD)"
            git reset --hard HEAD~${{ github.event.inputs.commits_back }}
            echo "New HEAD: $(git rev-parse --short HEAD)"
            export $(grep -v '^#' .env.local | xargs)
            npx prisma generate --schema=prisma/schema.postgresql.prisma
            npm run build:prod
            pm2 reload blog-staging
            echo "Rollback complete!"
